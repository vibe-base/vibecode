apiVersion: v1
kind: ConfigMap
metadata:
  name: caddy-config
  labels:
    {{- include "vibecode.labels" . | nindent 4 }}
data:
  Caddyfile: |
    {
      # Global options
      admin off
      # Email for Let's Encrypt notifications
      email {{ .Values.caddy.email | default "admin@example.com" }}
    }

    # Handle HTTP and HTTPS
    :80, :443 {
      # Enable automatic HTTPS
      tls {
        issuer acme
      }

      # Route to frontend
      handle_path / {
        reverse_proxy frontend:{{ .Values.frontend.port }}
      }

      # Route to Express API
      handle_path /api/express/* {
        uri strip_prefix /api/express
        reverse_proxy express:{{ .Values.express.port }}
      }

      # Route to FastAPI
      handle_path /api/* {
        uri strip_prefix /api
        reverse_proxy fastapi:{{ .Values.fastapi.port }}
      }

      # Health check
      handle /health {
        respond "OK" 200
      }

      # Log requests
      log {
        output stdout
        format console
      }
    }
