{
  # Global options
  admin off
  # Log to stdout for Docker
  log {
    output stdout
    format console
  }
}

# Handle HTTP and HTTPS
:80, :443 {
  # Automatic HTTPS with Let's Encrypt
  # In production, remove the 'internal' to use real certificates
  tls internal

  # Route to frontend
  handle_path / {
    reverse_proxy frontend:3000
  }

  # Route to Express API
  handle_path /api/express/* {
    uri strip_prefix /api/express
    reverse_proxy express:5000
  }

  # Route to FastAPI
  handle_path /api/* {
    uri strip_prefix /api
    reverse_proxy fastapi:8000
  }

  # Health check
  handle /health {
    respond "OK" 200
  }

  # Handle errors
  handle_errors {
    respond "{http.error.status_code} {http.error.status_text}" {http.error.status_code}
  }
}
